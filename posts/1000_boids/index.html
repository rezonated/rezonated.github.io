<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://rezonated.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rezonated.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rezonated.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://rezonated.github.io/android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://rezonated.github.io/apple-touch-icon.png><meta name=description content="A step-by-step account of optimizing a boids flocking simulation in Unreal Engine, from an initial actor-based implementation to a data-oriented, parallelized, and GPU-accelerated system."><title>Simulating 1000 flocking fish in Unreal Engine | V's personal site</title><link rel=canonical href=https://rezonated.github.io/posts/1000_boids/><meta property="og:url" content="https://rezonated.github.io/posts/1000_boids/"><meta property="og:site_name" content="V's personal site"><meta property="og:title" content="Simulating 1000 flocking fish in Unreal Engine"><meta property="og:description" content="A step-by-step account of optimizing a boids flocking simulation in Unreal Engine, from an initial actor-based implementation to a data-oriented, parallelized, and GPU-accelerated system."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-10T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-10T00:00:00+00:00"><meta property="article:tag" content="Dod"><meta property="article:tag" content="Ue"><meta property="article:tag" content="C++"><meta property="article:tag" content="Boids"><meta property="article:tag" content="Performance"><meta property="article:tag" content="Optimization"><link rel=stylesheet href=/assets/combined.min.df9b6321051b464d71ce502bb8b0e734e1a2fe8bee8ab6b34988129419f92db8.css media=all></head><body class=dark><div class=content><header><div class=header></div></header><main class=main><div class=breadcrumbs><a href=/>~</a><span class=breadcrumbs-separator>/</span><a href=/posts/>Posts</a><span class=breadcrumbs-separator>/</span>
<a href=/posts/1000_boids/>Simulating 1000 flocking fish in Unreal Engine</a></div><div class=autonumber><article><header class=single-intro-container><h1 class=single-title>Simulating 1000 flocking fish in Unreal Engine</h1><div class=single-subsummary><div><p class=single-date><time datetime=2025-11-10T00:00:00+00:00>November 10, 2025</time>
&nbsp; Â· &nbsp;27 min read</p></div></div></header><div class=single-content><h1 class=heading id=introduction>Introduction
<a class=anchor href=#introduction>#</a></h1><p>Simulating the flocking behavior of birds or the schooling of fish is a classic problem in computer graphics. The Boids algorithm, created by <a href=https://www.red3d.com/cwr/>Craig Reynolds</a> in 1986, offers a powerful solution. It demonstrates how complex, life-like group motion can emerge from individuals following a few simple rules, without any central leader or complex choreography.</p><p>This principle offers a way to add life to game worlds. A common application is simulating a school of fish, but a significant technical challenge arises when scaling up to large numbers. The target here was to effectively simulate a school of 1000 fish, moving as one cohesive unit while still allowing for individual interaction.</p><p>The initial implementation used a standard Unreal Engine approach: an <code>AActor_Fish</code> class with the basic boids logic in its <code>Tick</code> function. When spawning 1000 instances, the result was a slideshow. Performance cratered to around 6 FPS.</p><p>This post outlines my step-by-step journey, taking that simulation from a crawl to a fluid 70+ FPS. We&rsquo;ll cover profiling, shifting from a object-oriented setup to a data-oriented design, and leveraging Unreal Engine&rsquo;s features for parallel processing and GPU acceleration, all while maintaining the crucial gameplay feature of selecting and catching a single fish from the crowd.</p><p>For context, the starting point is a common actor-based approach where each fish is an <code>AActor_Fish</code> instance managing its own state. This caused performance issues due to actor ticking overhead and inefficient neighbor searches. Through successive passes, these were addressed, keeping the ability to interact with individual fish intact.</p><p>All tests were conducted on a machine with a Ryzen 5950X 16-core CPU, 128GB DDR4-3200 memory, and an RTX 3070 Ti GPU. To establish a fair baseline, measurements were taken in standalone mode in DebugGame configuration with the Rider debugger attached. This provides a conservative estimate. If the simulation performs well under these conditions, it will run even smoother in optimized shipping builds.</p><h1 class=heading id=the-gameplay-loop-catching-a-fish-in-a-sea-of-data>The Gameplay Loop: Catching a Fish in a Sea of Data
<a class=anchor href=#the-gameplay-loop-catching-a-fish-in-a-sea-of-data>#</a></h1><p>Before covering phases, it&rsquo;s crucial to understand the core gameplay loop handled by <code>UActorComponent_FishingComponent</code>. This loop coordinates player input, animations, UI, and the fish simulation itself. The main challenge at scale is to perform steps like &ldquo;Find the nearest fish&rdquo; and &ldquo;Control a single fish&rdquo; without stalling the entire system.</p><div class=mermaid align=center>sequenceDiagram
participant Player
participant FishingComponent
participant AnimBP as Animation Blueprint
participant FishSim as Fish Simulation
participant TargetFish as Targeted Fish
Player->>FishingComponent: Hold LMB (OnCastAction)
loop Charging Cast
FishingComponent->>FishingComponent: Update Decal & Cast Power
FishingComponent->>Player: Broadcast UI Progress
end
Player->>FishingComponent: Release LMB (OnCastActionEnded)
FishingComponent->>AnimBP: Play "Throw" Animation
Note right of AnimBP: Animation plays...
AnimBP-->>FishingComponent: AnimNotify: LaunchBobber
Note left of FishingComponent: Bobber flies and lands...
FishingComponent->>FishingComponent: OnBobberLandsOnWater()
FishingComponent->>FishSim: FindNearestFish(Location)
FishSim-->>FishingComponent: Return Fish Index
FishingComponent->>FishSim: PromoteBoidToActor(Index)
FishSim-->>FishingComponent: Return Spawned Actor (TargetFish)
Note over FishingComponent, TargetFish: Bite timer starts...
alt Player Reels In Successfully
Player->>FishingComponent: Click LMB (After Bite)
FishingComponent->>TargetFish: ReeledIn()
TargetFish->>TargetFish: Move towards player
Player->>FishingComponent: Click LMB again
FishingComponent->>TargetFish: Catch()
TargetFish->>TargetFish: Attach to rod
else Player Reels In Too Early
Player->>FishingComponent: Click LMB (Before Bite)
FishingComponent->>TargetFish: Escape()
TargetFish->>TargetFish: Flee and despawn
end</div><script src=https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,theme:"dark"})</script><p>Here&rsquo;s a breakdown of the steps shown in the diagram:</p><ol><li><strong>Charging The Cast:</strong> The player holds LMB. The <code>OnCastAction</code> delegate in the <code>FishingComponent</code> calculates the cast distance and updates a target decal on the water.</li><li><strong>Casting:</strong> Releasing LMB triggers <code>OnCastActionEnded</code>, which tells the animation blueprint to play a &ldquo;throw&rdquo; animation.</li><li><strong>The Bobber Flies:</strong> An anim notify within the throw animation sends a message back to the <code>FishingComponent</code> to launch the bobber projectile.</li><li><strong>Finding The Fish:</strong> When the bobber lands, <code>OnBobberLandsOnWater</code> is called. This is a critical step: it queries the <code>FishManager</code> (our simulation) to find the nearest fish data point. The manager then &ldquo;promotes&rdquo; this data point into a full <code>AActor_Fish</code> for interaction.</li><li><strong>The Bite:</strong> A timer starts. When it ends, the newly spawned fish actor is &ldquo;hooked.&rdquo; Its simulation logic is overridden, and it begins moving toward the bobber.</li><li><strong>Reeling In:</strong> Clicking LMB <em>after</em> the bite successfully catches the fish. Clicking <em>before</em> the bite causes it to escape, and the actor is &ldquo;demoted&rdquo; back into a data point in the simulation.</li></ol><p>In code, this uses interfaces like <code>ICatchableInterface</code>, implemented by <code>AActor_Fish</code>. When selected, the fish&rsquo;s <code>bBeingTargeted</code> flag disables flocking and enables timeline-based movement.</p><p>The <code>UActorComponent_FishingComponent</code> manages states, timers, and interactions between the player, rod (<code>ICatcherInterface</code>), and fish.</p><p>Here&rsquo;s the casting handling in <code>UActorComponent_FishingComponent</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UActorComponent_FishingComponent<span style=color:#ff79c6>::</span>OnCastAction(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span><span style=color:#ff79c6>&amp;</span> InElapsedTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (CurrentFishingState <span style=color:#ff79c6>!=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_Idling) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    DetermineCastLocation(InElapsedTime);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    AttemptToCast(InitialActorLocation <span style=color:#ff79c6>+</span> InitialActorForwardVector <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>100.f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> Progress <span style=color:#ff79c6>=</span> GetMappedElapsedTimeToMaximumCastTime(InElapsedTime);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    BroadcastUIMessage(Progress);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd>void</span> UActorComponent_FishingComponent<span style=color:#ff79c6>::</span>OnCastActionEnded(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span><span style=color:#ff79c6>&amp;</span> InElapsedTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ToggleDecalVisibility(<span style=color:#8be9fd;font-style:italic>false</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> (CurrentFishingState <span style=color:#ff79c6>!=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_Idling) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    CurrentFishingState <span style=color:#ff79c6>=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_Casting;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    UVAGameplayMessagingSubsystem<span style=color:#ff79c6>::</span>Get(<span style=color:#ff79c6>this</span>).BroadcastMessage(<span style=color:#ff79c6>this</span>, FFishingTags<span style=color:#ff79c6>::</span>Get().Messaging_Fishing_AnimInstance_StateChange, FFishingTags<span style=color:#ff79c6>::</span>Get().AnimInstance_Fishing_State_Casting);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><p>When the bobber lands, it searches for the nearest fish:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> UActorComponent_FishingComponent<span style=color:#ff79c6>::</span>OnBobberLandsOnWater(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> InBobberLandsOnWaterLocation)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>if</span> (CurrentFishingState <span style=color:#ff79c6>!=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_Casting) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    CurrentFishingState <span style=color:#ff79c6>=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_WaitingForFish;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    MockBobberLandsOnWaterDelegate.Broadcast(<span style=color:#bd93f9>0.f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    AttemptGetNearestCatchable();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>The fish interaction via <code>ICatchableInterface</code> in <code>AActor_Fish</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>ReeledIn(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> RodLocation)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    bBeingTargeted <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    ReelInLocation <span style=color:#ff79c6>=</span> RodLocation;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    LookAtReelInRotation <span style=color:#ff79c6>=</span> UKismetMathLibrary<span style=color:#ff79c6>::</span>FindLookAtRotation(GetActorLocation(), ReelInLocation);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ReeledInTimeline.PlayFromStart();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Escape()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    ReeledInTimeline.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    EscapeRotation <span style=color:#ff79c6>=</span> UKismetMathLibrary<span style=color:#ff79c6>::</span>FindLookAtRotation(GetActorLocation(), InitialActorLocation);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    EscapeTimeline.PlayFromStart();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Catch(USceneComponent<span style=color:#ff79c6>*</span> InCatchingRod)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>InCatchingRod) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    bBeingTargeted <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    AttachToComponent(InCatchingRod, FAttachmentTransformRules<span style=color:#ff79c6>::</span>SnapToTargetIncludingScale, NAME_None);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>}
</span></span></code></pre></div><p>The component mediates the reel-in:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> UActorComponent_FishingComponent<span style=color:#ff79c6>::</span>ReelInCurrentCatchable()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>CurrentCatchable) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>CurrentCatcher) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    CurrentCatchable<span style=color:#ff79c6>-&gt;</span>Catch(CurrentCatcher<span style=color:#ff79c6>-&gt;</span>GetCatcherAttachComponent());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    CurrentFishingState <span style=color:#ff79c6>=</span> FFishingTags<span style=color:#ff79c6>::</span>Get().FishingComponent_State_ReelingIn;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    UVAGameplayMessagingSubsystem<span style=color:#ff79c6>::</span>Get(<span style=color:#ff79c6>this</span>).BroadcastMessage(<span style=color:#ff79c6>this</span>, FFishingTags<span style=color:#ff79c6>::</span>Get().Messaging_Fishing_AnimInstance_StateChange, FFishingTags<span style=color:#ff79c6>::</span>Get().AnimInstance_Fishing_State_ReelingIn);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>This setup supports integration between player input, animations, and fish behavior.</p><h1 class=heading id=what-are-boids-anyway>What Are Boids, Anyway?
<a class=anchor href=#what-are-boids-anyway>#</a></h1><p>The Boids algorithm is a classic in the world of artificial life, first presented by Craig Reynolds in 1987 at the SIGGRAPH conference. <a href=https://www.cs.toronto.edu/~dt/siggraph97-course/cwr87/>His paper</a>, &ldquo;Flocks, Herds, and Schools: A Distributed Behavioral Model,&rdquo; was revolutionary. Instead of programming a complex central brain to command the flock, Reynolds proposed that intricate, life-like motion could emerge from each individual &ldquo;boid&rdquo; (a portmanteau of &ldquo;bird-oid object&rdquo;) following three simple, local rules.</p><p>These rules only require a boid to consider its immediate neighbors, not the entire flock. This decentralized approach is what makes the simulation so powerful and, as we&rsquo;ll see, presents its primary performance challenge. The three original rules are:</p><ol><li><strong>Separation</strong>: Steer to avoid crowding local flockmates.</li><li><strong>Alignment</strong>: Steer towards the average heading of local flockmates.</li><li><strong>Cohesion</strong>: Steer to move toward the average position (center of mass) of local flockmates.</li></ol><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=boids-rules-viz style=position:relative;width:100%;height:450px><div id=boids-rules-viz-ui style=position:absolute;top:10px;left:10px;background:rgba(255,255,255,.8);backdrop-filter:blur(5px);border-radius:5px;padding:8px;font-family:sans-serif;font-size:12px;display:none;z-index:10><p style="margin:0 0 5px;font-weight:700">Controls:</p><div id=boids-rules-viz-controls></div><p id=boids-rules-viz-help-text style="margin:10px 0 5px;font-size:11px;color:#555"></p></div><div id=boids-rules-viz-overlay style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.5);color:#fff;padding:5px 10px;border-radius:3px;font-family:monospace;font-size:14px;display:none;z-index:10"></div></div></div><script type=module>
    if ('boids-rules' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('boids-rules-viz-container'));
    } else if ('boids-rules' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('boids-rules-viz-container'));
    } else if ('boids-rules' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('boids-rules-viz-container'));
    } else if ('boids-rules' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('boids-rules-viz-left');
        const right = document.getElementById('boids-rules-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('boids-rules-viz');
        const uiPanel = document.getElementById('boids-rules-viz-ui');
        const controlsContainer = document.getElementById('boids-rules-viz-controls');
        const helpText = document.getElementById('boids-rules-viz-help-text');
        const overlay = document.getElementById('boids-rules-viz-overlay');
        initScene(container, 'boids-rules', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><p>When translated into code, these three rules, along with a fourth one for boundary containment, form the core of our simulation logic. In the initial <code>AActor_Fish</code> class, these were applied every fram in <code>Tick</code> function.</p><h3 class=heading id=the-core-tick-logic-baseline>The Core <code>Tick</code> Logic (Baseline)
<a class=anchor href=#the-core-tick-logic-baseline>#</a></h3><p>Each fish processed this logic independently.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaSeconds)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Super<span style=color:#ff79c6>::</span>Tick(DeltaSeconds);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Flock(DeltaSeconds); <span style=color:#6272a4>// Contains all boids logic
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    TickTimelines(DeltaSeconds); <span style=color:#6272a4>// For player interaction
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Flock(<span style=color:#8be9fd>float</span> DeltaSeconds)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>if</span> (bBeingTargeted <span style=color:#ff79c6>||</span> DeltaSeconds <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0.f</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>// 1. Find Neighbors (The bottleneck!)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;</span> Neighbors;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    GetNeighbors(Neighbors);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4>// 2. Calculate the total steering force from all rules
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> FVector SteeringForce <span style=color:#ff79c6>=</span> CalculateFlockForce(Neighbors);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#6272a4>// 3. Apply force to velocity (simple Euler integration)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span>    Velocity <span style=color:#ff79c6>+=</span> SteeringForce <span style=color:#ff79c6>*</span> DeltaSeconds;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    Velocity <span style=color:#ff79c6>=</span> Velocity.GetClampedToMaxSize(MaxSpeed);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#6272a4>// 4. Update the actor&#39;s transform
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> FVector NewLocation <span style=color:#ff79c6>=</span> GetActorLocation() <span style=color:#ff79c6>+</span> Velocity <span style=color:#ff79c6>*</span> DeltaSeconds;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>const</span> FRotator TargetRotation <span style=color:#ff79c6>=</span> Velocity.ToOrientationRotator();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>const</span> FRotator InterpolatedRotation <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>RInterpTo(GetActorRotation(), TargetRotation, DeltaSeconds, <span style=color:#bd93f9>10.0f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    SetActorLocationAndRotation(NewLocation, InterpolatedRotation);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>CalculateFlockForce(<span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> Neighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    <span style=color:#ff79c6>if</span> (bBeingTargeted) <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    <span style=color:#ff79c6>const</span> FVector FCohesion <span style=color:#ff79c6>=</span> Cohesion(Neighbors) <span style=color:#ff79c6>*</span> CohesionWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>const</span> FVector FSeparation <span style=color:#ff79c6>=</span> Separation(Neighbors) <span style=color:#ff79c6>*</span> SeparationWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#ff79c6>const</span> FVector FAlignment <span style=color:#ff79c6>=</span> Alignment(Neighbors) <span style=color:#ff79c6>*</span> AlignmentWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#ff79c6>const</span> FVector FBoundary <span style=color:#ff79c6>=</span> BoundaryContainment() <span style=color:#ff79c6>*</span> ContainmentWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    FVector TotalForce <span style=color:#ff79c6>=</span> FCohesion <span style=color:#ff79c6>+</span> FSeparation <span style=color:#ff79c6>+</span> FAlignment <span style=color:#ff79c6>+</span> FBoundary;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#ff79c6>return</span> TotalForce.GetClampedToMaxSize(MaxForce);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>}
</span></span></code></pre></div><p>The three core boids rules were implemented as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>Separation(<span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> Neighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    FVector RepulsionAccumulator <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    int32 Count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> DistSqThreshold <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Square(SeparationDistance);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> AActor_Fish<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>Other</span> : Neighbors)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        FVector Difference <span style=color:#ff79c6>=</span> GetActorLocation() <span style=color:#ff79c6>-</span> Other<span style=color:#ff79c6>-&gt;</span>GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#8be9fd>float</span> DistSq <span style=color:#ff79c6>=</span> Difference.SizeSquared();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> (DistSq <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>&amp;&amp;</span> DistSq <span style=color:#ff79c6>&lt;</span> DistSqThreshold)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            RepulsionAccumulator <span style=color:#ff79c6>+=</span> Difference.GetSafeNormal() <span style=color:#ff79c6>/</span> FMath<span style=color:#ff79c6>::</span>Sqrt(DistSq);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            Count<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>if</span> (Count <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        RepulsionAccumulator <span style=color:#ff79c6>/=</span> Count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>RepulsionAccumulator.IsNearlyZero()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            FVector TargetVel <span style=color:#ff79c6>=</span> RepulsionAccumulator.GetSafeNormal() <span style=color:#ff79c6>*</span> MaxSpeed;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>Steer</span>(TargetVel);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>Alignment(<span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> Neighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    FVector AvgVelocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    int32 AlignCount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> AActor_Fish<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>Fish</span> : Neighbors)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#ff79c6>if</span> (Fish<span style=color:#ff79c6>-&gt;</span>GetFlockGroupID() <span style=color:#ff79c6>==</span> GetFlockGroupID())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            AvgVelocity <span style=color:#ff79c6>+=</span> Fish<span style=color:#ff79c6>-&gt;</span>Velocity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            AlignCount<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    <span style=color:#ff79c6>if</span> (AlignCount <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        AvgVelocity <span style=color:#ff79c6>/=</span> AlignCount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>Steer</span>(AvgVelocity);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>Cohesion(<span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> Neighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    FVector CenterOfMass <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    int32 CohesionCount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> AActor_Fish<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>Fish</span> : Neighbors)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>        <span style=color:#ff79c6>if</span> (Fish<span style=color:#ff79c6>-&gt;</span>GetFlockGroupID() <span style=color:#ff79c6>==</span> GetFlockGroupID())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            CenterOfMass <span style=color:#ff79c6>+=</span> Fish<span style=color:#ff79c6>-&gt;</span>GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>            CohesionCount<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    <span style=color:#ff79c6>if</span> (CohesionCount <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>        CenterOfMass <span style=color:#ff79c6>/=</span> CohesionCount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>Steer</span>(CenterOfMass <span style=color:#ff79c6>-</span> GetActorLocation());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>    <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>}
</span></span></code></pre></div><p>The <code>Steer</code> function, common to all rules, computes the steering force toward a desired velocity:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>Steer(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> Target) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (MaxSpeed <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0.0f</span> <span style=color:#ff79c6>||</span> MaxForce <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0.0f</span>) <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    FVector DesiredVelocity <span style=color:#ff79c6>=</span> Target;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>DesiredVelocity.IsNearlyZero())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        DesiredVelocity <span style=color:#ff79c6>=</span> DesiredVelocity.GetClampedToSize(<span style=color:#bd93f9>0.0f</span>, MaxSpeed);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    FVector Steering <span style=color:#ff79c6>=</span> DesiredVelocity <span style=color:#ff79c6>-</span> Velocity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>if</span> (Steering.SizeSquared() <span style=color:#ff79c6>&lt;=</span> FMath<span style=color:#ff79c6>::</span>Square(MaxForce)) <span style=color:#ff79c6>return</span> Steering;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    Steering <span style=color:#ff79c6>=</span> Steering.GetClampedToMaxSize(MaxForce);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>return</span> Steering;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>Additionally, a boundary containment rule keeps fish within their spawn area:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>FVector AActor_Fish<span style=color:#ff79c6>::</span>BoundaryContainment() <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>const</span> FVector Location <span style=color:#ff79c6>=</span> GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>const</span> FVector BoxMin <span style=color:#ff79c6>=</span> ContainingSpawnAreaCenter <span style=color:#ff79c6>-</span> ContainingSpawnAreaBoxExtent;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>const</span> FVector BoxMax <span style=color:#ff79c6>=</span> ContainingSpawnAreaCenter <span style=color:#ff79c6>+</span> ContainingSpawnAreaBoxExtent;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    FVector Force <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#ff79c6>auto</span> CalculateAxisRepulsion <span style=color:#ff79c6>=</span> [<span style=color:#ff79c6>&amp;</span>](<span style=color:#8be9fd>float</span> CurrentPos, <span style=color:#8be9fd>float</span> MinPos, <span style=color:#8be9fd>float</span> MaxPos, <span style=color:#8be9fd>float</span> CheckDist, <span style=color:#8be9fd>float</span><span style=color:#ff79c6>&amp;</span> OutForceComponent)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> DistToMin <span style=color:#ff79c6>=</span> CurrentPos <span style=color:#ff79c6>-</span> MinPos;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> DistToMax <span style=color:#ff79c6>=</span> MaxPos <span style=color:#ff79c6>-</span> CurrentPos;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#8be9fd>float</span> Strength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.0f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>if</span> (DistToMin <span style=color:#ff79c6>&lt;</span> CheckDist)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            Strength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1.0f</span> <span style=color:#ff79c6>-</span> (DistToMin <span style=color:#ff79c6>/</span> CheckDist);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            OutForceComponent <span style=color:#ff79c6>+=</span> FMath<span style=color:#ff79c6>::</span>Lerp(<span style=color:#bd93f9>0.0f</span>, MaxForce, Strength);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>else</span> <span style=color:#50fa7b>if</span> (DistToMax <span style=color:#ff79c6>&lt;</span> CheckDist)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            Strength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1.0f</span> <span style=color:#ff79c6>-</span> (DistToMax <span style=color:#ff79c6>/</span> CheckDist);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            OutForceComponent <span style=color:#ff79c6>-=</span> FMath<span style=color:#ff79c6>::</span>Lerp(<span style=color:#bd93f9>0.0f</span>, MaxForce, Strength);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>if</span> (CurrentPos <span style=color:#ff79c6>&lt;</span> MinPos <span style=color:#ff79c6>||</span> CurrentPos <span style=color:#ff79c6>&gt;</span> MaxPos)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            OutForceComponent <span style=color:#ff79c6>=</span> (CurrentPos <span style=color:#ff79c6>&lt;</span> MinPos) <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>MaxForce</span> : <span style=color:#ff79c6>-</span>MaxForce;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    CalculateAxisRepulsion(Location.X, BoxMin.X, BoxMax.X, ContainmentCheckDistance, Force.X);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    CalculateAxisRepulsion(Location.Y, BoxMin.Y, BoxMax.Y, ContainmentCheckDistance, Force.Y);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    CalculateAxisRepulsion(Location.Z, BoxMin.Z, BoxMax.Z, ContainmentCheckDistance, Force.Z);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>return</span> Force;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>}
</span></span></code></pre></div><p>The logic was functional, but performance needed improvement. The main issue was in <code>GetNeighbors</code>.</p><h1 class=heading id=the-starting-point-the-actor-based-on-approach>The Starting Point: The Actor-Based O(NÂ²) Approach
<a class=anchor href=#the-starting-point-the-actor-based-on-approach>#</a></h1><p>The <code>GetNeighbors</code> function was the primary bottleneck.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=on2-viz style=position:relative;width:100%;height:450px><div id=on2-viz-ui style=position:absolute;top:10px;left:10px;background:rgba(255,255,255,.8);backdrop-filter:blur(5px);border-radius:5px;padding:8px;font-family:sans-serif;font-size:12px;display:none;z-index:10><p style="margin:0 0 5px;font-weight:700">Controls:</p><div id=on2-viz-controls></div><p id=on2-viz-help-text style="margin:10px 0 5px;font-size:11px;color:#555"></p></div><div id=on2-viz-overlay style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.5);color:#fff;padding:5px 10px;border-radius:3px;font-family:monospace;font-size:14px;display:none;z-index:10"></div></div></div><script type=module>
    if ('on2-problem' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('on2-viz-container'));
    } else if ('on2-problem' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('on2-viz-container'));
    } else if ('on2-problem' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('on2-viz-container'));
    } else if ('on2-problem' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('on2-viz-left');
        const right = document.getElementById('on2-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('on2-viz');
        const uiPanel = document.getElementById('on2-viz-ui');
        const controlsContainer = document.getElementById('on2-viz-controls');
        const helpText = document.getElementById('on2-viz-help-text');
        const overlay = document.getElementById('on2-viz-overlay');
        initScene(container, 'on2-problem', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>GetNeighbors(TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> OutNeighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    OutNeighbors.Empty();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>const</span> UWorld<span style=color:#ff79c6>*</span> World <span style=color:#ff79c6>=</span> GetWorld();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>World) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    TArray<span style=color:#ff79c6>&lt;</span>AActor<span style=color:#ff79c6>*&gt;</span> FoundActors;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#6272a4>// The main offender: iterating all actors for every single fish.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#6272a4></span>    UGameplayStatics<span style=color:#ff79c6>::</span>GetAllActorsOfClass(World, StaticClass(), FoundActors);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>const</span> FVector CurrentLocation <span style=color:#ff79c6>=</span> GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> RadiusSquared <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Square(NeighborRadius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#ff79c6>for</span> (AActor<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>Actor</span> : FoundActors)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#ff79c6>if</span> (Actor <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>this</span>) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        AActor_Fish<span style=color:#ff79c6>*</span> Fish <span style=color:#ff79c6>=</span> Cast<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span>(Actor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>Fish <span style=color:#ff79c6>||</span> Fish<span style=color:#ff79c6>-&gt;</span>bBeingTargeted) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#ff79c6>if</span> (FVector<span style=color:#ff79c6>::</span>DistSquared(CurrentLocation, Fish<span style=color:#ff79c6>-&gt;</span>GetActorLocation()) <span style=color:#ff79c6>&gt;</span> RadiusSquared) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        OutNeighbors.Add(Fish);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>}
</span></span></code></pre></div><p>For 1000 fish, this resulted in approximately 1,000,000 iterations per frame due to repeated actor list scans.</p><p>Profiling showed <code>GetAllActorsOfClass</code> taking most CPU time, as it scans the full actor list each time. Distance checks contributed to the quadratic O(NÂ²) complexity for neighbor queries.<figure><div class=img-container><img loading=lazy alt="Baseline Profile" src=/posts/1000_boids/baseline_profile_a.png></div></figure></p><p><figure><div class=img-container><img loading=lazy alt="Baseline Profile" src=/posts/1000_boids/baseline_profile_b.png></div></figure></p><p><strong>The Result:</strong> Straightforward to implement, but led to significant performance issues. 6 FPS Max.<figure><div class=img-container><img loading=lazy alt="Baseline Result" src=/posts/1000_boids/baseline.png></div></figure></p><h1 class=heading id=step-1-implementing-a-spatial-grid>Step 1: Implementing a Spatial Grid
<a class=anchor href=#step-1-implementing-a-spatial-grid>#</a></h1><p>A spatial hash grid divides space into cells.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=spatial-grid-viz style=position:relative;width:100%;height:450px><div id=spatial-grid-viz-ui style=position:absolute;top:10px;left:10px;background:rgba(255,255,255,.8);backdrop-filter:blur(5px);border-radius:5px;padding:8px;font-family:sans-serif;font-size:12px;display:none;z-index:10><p style="margin:0 0 5px;font-weight:700">Controls:</p><div id=spatial-grid-viz-controls></div><p id=spatial-grid-viz-help-text style="margin:10px 0 5px;font-size:11px;color:#555"></p></div><div id=spatial-grid-viz-overlay style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.5);color:#fff;padding:5px 10px;border-radius:3px;font-family:monospace;font-size:14px;display:none;z-index:10"></div></div></div><script type=module>
    if ('spatial-grid' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('spatial-grid-viz-container'));
    } else if ('spatial-grid' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('spatial-grid-viz-container'));
    } else if ('spatial-grid' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('spatial-grid-viz-container'));
    } else if ('spatial-grid' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('spatial-grid-viz-left');
        const right = document.getElementById('spatial-grid-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('spatial-grid-viz');
        const uiPanel = document.getElementById('spatial-grid-viz-ui');
        const controlsContainer = document.getElementById('spatial-grid-viz-controls');
        const helpText = document.getElementById('spatial-grid-viz-help-text');
        const overlay = document.getElementById('spatial-grid-viz-overlay');
        initScene(container, 'spatial-grid', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><p>This was added in <code>UTickableWorldSubsystem_FishManager</code>.</p><p>The manager tracks fish instances.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// In AActor_Fish.h
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span><span style=color:#ff79c6>virtual</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>BeginPlay</span>() <span style=color:#ff79c6>override</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>virtual</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>EndPlay</span>(<span style=color:#ff79c6>const</span> EEndPlayReason<span style=color:#ff79c6>::</span>Type EndPlayReason) <span style=color:#ff79c6>override</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4>// In AActor_Fish.cpp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>BeginPlay()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    Super<span style=color:#ff79c6>::</span>BeginPlay();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>const</span> UWorld<span style=color:#ff79c6>*</span> World <span style=color:#ff79c6>=</span> GetWorld())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#ff79c6>if</span> (UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>*</span> FishManager <span style=color:#ff79c6>=</span> World<span style=color:#ff79c6>-&gt;</span>GetSubsystem<span style=color:#ff79c6>&lt;</span>UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>&gt;</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            FishManager<span style=color:#ff79c6>-&gt;</span>RegisterFish(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>EndPlay(<span style=color:#ff79c6>const</span> EEndPlayReason<span style=color:#ff79c6>::</span>Type EndPlayReason)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>const</span> UWorld<span style=color:#ff79c6>*</span> World <span style=color:#ff79c6>=</span> GetWorld())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>*</span> FishManager <span style=color:#ff79c6>=</span> World<span style=color:#ff79c6>-&gt;</span>GetSubsystem<span style=color:#ff79c6>&lt;</span>UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>&gt;</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            FishManager<span style=color:#ff79c6>-&gt;</span>UnregisterFish(<span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    Super<span style=color:#ff79c6>::</span>EndPlay(EndPlayReason);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>}
</span></span></code></pre></div><p>The <code>FishManager</code> stores actors and updates the grid in its <code>Tick</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>UCLASS()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>FISHINGFEATURE_API</span> <span style=color:#8be9fd;font-style:italic>UTickableWorldSubsystem_FishManager</span> : <span style=color:#ff79c6>public</span> UTickableWorldSubsystem
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>GENERATED_BODY()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>virtual</span> <span style=color:#8be9fd>void</span> Tick(<span style=color:#8be9fd>float</span> DeltaTime) <span style=color:#ff79c6>override</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>RegisterFish</span>(AActor_Fish<span style=color:#ff79c6>*</span> InFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>UnregisterFish</span>(AActor_Fish<span style=color:#ff79c6>*</span> InFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>FindNeighborsInRadius</span>(<span style=color:#ff79c6>const</span> AActor_Fish<span style=color:#ff79c6>*</span> InFishActor, int32 InRadius, TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> OutNeighbors) <span style=color:#ff79c6>const</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>private</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#8be9fd>void</span> UpdateSpatialGrid();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>UPROPERTY(Transient)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;</span> AllFish;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>TMap<span style=color:#ff79c6>&lt;</span>FIntVector, TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&gt;</span> SpatialGrid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd>float</span> CellSize <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1000.0f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Super<span style=color:#ff79c6>::</span>Tick(DeltaTime);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    UpdateSpatialGrid(); <span style=color:#6272a4>// Rebuild the grid every frame with the latest fish positions
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>RegisterFish(AActor_Fish<span style=color:#ff79c6>*</span> InFishActor)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (IsValid(InFishActor)) AllFish.Add(InFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>UnregisterFish(AActor_Fish<span style=color:#ff79c6>*</span> InFishActor)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#ff79c6>if</span> (IsValid(InFishActor)) AllFish.Remove(InFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>UpdateSpatialGrid()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    SpatialGrid.Reset();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>for</span> (AActor_Fish<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>Fish</span> : AllFish)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>IsValid(Fish)) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> Position <span style=color:#ff79c6>=</span> Fish<span style=color:#ff79c6>-&gt;</span>GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>const</span> FIntVector <span style=color:#50fa7b>CellCoord</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            FMath<span style=color:#ff79c6>::</span>FloorToInt(Position.X <span style=color:#ff79c6>/</span> CellSize),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            FMath<span style=color:#ff79c6>::</span>FloorToInt(Position.Y <span style=color:#ff79c6>/</span> CellSize),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            FMath<span style=color:#ff79c6>::</span>FloorToInt(Position.Z <span style=color:#ff79c6>/</span> CellSize)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        SpatialGrid.FindOrAdd(CellCoord).Add(Fish);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>FindNeighborsInRadius(<span style=color:#ff79c6>const</span> AActor_Fish<span style=color:#ff79c6>*</span> InFishActor, int32 InRadius, TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> OutNeighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    OutNeighbors.Reset();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>IsValid(InFishActor)) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> FishLocation <span style=color:#ff79c6>=</span> InFishActor<span style=color:#ff79c6>-&gt;</span>GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> RadiusSquared <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Square(InRadius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#ff79c6>const</span> FIntVector <span style=color:#50fa7b>OriginCellCoord</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        FMath<span style=color:#ff79c6>::</span>FloorToInt(FishLocation.X <span style=color:#ff79c6>/</span> CellSize),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        FMath<span style=color:#ff79c6>::</span>FloorToInt(FishLocation.Y <span style=color:#ff79c6>/</span> CellSize),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        FMath<span style=color:#ff79c6>::</span>FloorToInt(FishLocation.Z <span style=color:#ff79c6>/</span> CellSize)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    <span style=color:#6272a4>// Iterate through the 3x3x3 cube of cells around the origin cell
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> Z <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>; Z <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span>; <span style=color:#ff79c6>++</span>Z)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> Y <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>; Y <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span>; <span style=color:#ff79c6>++</span>Y)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> X <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>; X <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>1</span>; <span style=color:#ff79c6>++</span>X)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>                <span style=color:#ff79c6>const</span> FIntVector <span style=color:#50fa7b>CellToCheck</span>(OriginCellCoord <span style=color:#ff79c6>+</span> FIntVector(X, Y, Z));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>                <span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;*</span> FishesInCell <span style=color:#ff79c6>=</span> SpatialGrid.Find(CellToCheck);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>                <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>FishesInCell) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>               
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                <span style=color:#ff79c6>for</span> (AActor_Fish<span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>PotentialNeighbor</span> : <span style=color:#ff79c6>*</span>FishesInCell)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>                    <span style=color:#ff79c6>if</span> (PotentialNeighbor <span style=color:#ff79c6>==</span> InFishActor) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>                    <span style=color:#ff79c6>if</span> (FVector<span style=color:#ff79c6>::</span>DistSquared(FishLocation, PotentialNeighbor<span style=color:#ff79c6>-&gt;</span>GetActorLocation()) <span style=color:#ff79c6>&gt;</span> RadiusSquared) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>                    OutNeighbors.Add(PotentialNeighbor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>}
</span></span></code></pre></div><p>The cell size (1000 units) approximated the neighbor radius, limiting queries to nearby cells (27 in 3D). This reduced average neighbor checks from N to a constant, making the simulation O(N) overall.</p><p>In <code>AActor_Fish::GetNeighbors</code>, the <code>GetAllActorsOfClass</code> was replaced with a manager query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>GetNeighbors(TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;&amp;</span> OutNeighbors) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    OutNeighbors.Empty();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>const</span> UWorld<span style=color:#ff79c6>*</span> World <span style=color:#ff79c6>=</span> GetWorld();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>World) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>*</span> FishManagerSubsystem <span style=color:#ff79c6>=</span> World<span style=color:#ff79c6>-&gt;</span>GetSubsystem<span style=color:#ff79c6>&lt;</span>UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>&gt;</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>FishManagerSubsystem) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    FishManagerSubsystem<span style=color:#ff79c6>-&gt;</span>FindNeighborsInRadius(<span style=color:#ff79c6>this</span>, NeighborRadius, OutNeighbors);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>Profiling indicated reduced time in neighbor searches, with grid rebuild being O(N) and queries localized.</p><p><figure><div class=img-container><img loading=lazy alt="Spatial Grid Profile" src=/posts/1000_boids/step_1_profile_a.png></div></figure></p><p><figure><div class=img-container><img loading=lazy alt="Spatial Grid Profile" src=/posts/1000_boids/step_1_profile_b.png></div></figure></p><p><strong>The Result:</strong> Addressed the O(NÂ²) issue. Performance improved to around 14 FPS max, though actor overhead remained.<figure><div class=img-container><img loading=lazy alt="Spatial Grid Result" src=/posts/1000_boids/step_1.png></div></figure></p><h1 class=heading id=step-2-centralizing-logic--array-of-structs-aos>Step 2: Centralizing Logic & Array of Structs (AoS)
<a class=anchor href=#step-2-centralizing-logic--array-of-structs-aos>#</a></h1><p>Next, actor overhead was reduced by making <code>AActor_Fish</code> handle only targeted states, moving simulation to the <code>FishManager</code> with an Array of Structs (AoS).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>USTRUCT()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>struct</span> <span style=color:#50fa7b>FFishData</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    GENERATED_BODY()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    UPROPERTY(Transient) TObjectPtr<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span> Fish <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    UPROPERTY(Transient) FVector Position <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    UPROPERTY(Transient) FVector Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    UPROPERTY(Transient) int32 FlockGroupID <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> MaxSpeed <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> MaxForce <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> NeighborRadius <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> SeparationDistance <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> CohesionWeight <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> SeparationWeight <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> AlignmentWeight <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> ContainmentWeight <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    UPROPERTY(Transient) <span style=color:#8be9fd>float</span> ContainmentCheckDistance <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    UPROPERTY(Transient) FVector SpawnAreaCenter <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    UPROPERTY(Transient) FVector SpawnAreaBoxExtent <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    UPROPERTY(Transient) int32 ID <span style=color:#ff79c6>=</span> INDEX_NONE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4>// In the manager class:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#6272a4></span>UPROPERTY(Transient) TArray<span style=color:#ff79c6>&lt;</span>FFishData<span style=color:#ff79c6>&gt;</span> AllFish;
</span></span></code></pre></div><p><code>AActor_Fish</code> disables ticking by default, enabling it only when targeted:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>AActor_Fish<span style=color:#ff79c6>::</span>AActor_Fish()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    PrimaryActorTick.bCanEverTick <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    PrimaryActorTick.bStartWithTickEnabled <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>ReeledIn(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> RodLocation)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    SetActorTickEnabled(<span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    bBeingTargeted <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    ReelInLocation <span style=color:#ff79c6>=</span> RodLocation;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    LookAtReelInRotation <span style=color:#ff79c6>=</span> (RodLocation <span style=color:#ff79c6>-</span> GetActorLocation()).Rotation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    ReeledInTimeline.PlayFromStart();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Escape()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    SetActorTickEnabled(<span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ReeledInTimeline.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    Velocity <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    EscapeRotation <span style=color:#ff79c6>=</span> (InitialActorLocation <span style=color:#ff79c6>-</span> GetActorLocation()).Rotation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    EscapeTimeline.PlayFromStart();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>}
</span></span></code></pre></div><p>The <code>Tick</code> in <code>AActor_Fish</code> handles only timelines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaSeconds)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    Super<span style=color:#ff79c6>::</span>Tick(DeltaSeconds);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    TickTimelines(DeltaSeconds);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div><p>The manager&rsquo;s <code>Tick</code> simulates data first, then applies to actors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (AllFish.Num() <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    UpdateSpatialGrid(); <span style=color:#6272a4>// Grid now maps to TArray&lt;int32&gt; (indices into AllFish)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> NextVelocities, NextPositions;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    NextVelocities.SetNumUninitialized(AllFish.Num());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    NextPositions.SetNumUninitialized(AllFish.Num());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#6272a4>// Phase 1: SIMULATE (Single-threaded)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> AllFish.Num(); <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>const</span> FFishData<span style=color:#ff79c6>&amp;</span> CurrentFish <span style=color:#ff79c6>=</span> AllFish[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>IsValid(CurrentFish.Fish) <span style=color:#ff79c6>||</span> CurrentFish.Fish<span style=color:#ff79c6>-&gt;</span>IsBeingTargeted())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            NextVelocities[i] <span style=color:#ff79c6>=</span> CurrentFish.Velocity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            NextPositions[i] <span style=color:#ff79c6>=</span> CurrentFish.Position;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;</span> NeighborIndices; <span style=color:#6272a4>// Indices into the AllFish array
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>        FindNeighborsInRadius(i, CurrentFish.NeighborRadius, NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>const</span> FVector FCohesion <span style=color:#ff79c6>=</span> Cohesion(i, NeighborIndices) <span style=color:#ff79c6>*</span> CurrentFish.CohesionWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>const</span> FVector FSeparation <span style=color:#ff79c6>=</span> Separation(i, NeighborIndices) <span style=color:#ff79c6>*</span> CurrentFish.SeparationWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#ff79c6>const</span> FVector FAlignment <span style=color:#ff79c6>=</span> Alignment(i, NeighborIndices) <span style=color:#ff79c6>*</span> CurrentFish.AlignmentWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>const</span> FVector FBoundary <span style=color:#ff79c6>=</span> BoundaryContainment(CurrentFish) <span style=color:#ff79c6>*</span> CurrentFish.ContainmentWeight;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>const</span> FVector TotalForce <span style=color:#ff79c6>=</span> FCohesion <span style=color:#ff79c6>+</span> FSeparation <span style=color:#ff79c6>+</span> FAlignment <span style=color:#ff79c6>+</span> FBoundary;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        FVector NewVelocity <span style=color:#ff79c6>=</span> CurrentFish.Velocity <span style=color:#ff79c6>+</span> TotalForce <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        NewVelocity <span style=color:#ff79c6>=</span> NewVelocity.GetClampedToMaxSize(CurrentFish.MaxSpeed);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        NextVelocities[i] <span style=color:#ff79c6>=</span> NewVelocity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        NextPositions[i] <span style=color:#ff79c6>=</span> CurrentFish.Position <span style=color:#ff79c6>+</span> NewVelocity <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#6272a4>// Phase 2: COMMIT &amp; APPLY
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> AllFish.Num(); <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        AllFish[i].Position <span style=color:#ff79c6>=</span> NextPositions[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        AllFish[i].Velocity <span style=color:#ff79c6>=</span> NextVelocities[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        <span style=color:#ff79c6>if</span> (AActor_Fish<span style=color:#ff79c6>*</span> FishActor <span style=color:#ff79c6>=</span> AllFish[i].Fish)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>             <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>FishActor<span style=color:#ff79c6>-&gt;</span>IsBeingTargeted())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>             {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>                 <span style=color:#ff79c6>const</span> FRotator NewRotation <span style=color:#ff79c6>=</span> AllFish[i].Velocity.ToOrientationRotator();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>                 FishActor<span style=color:#ff79c6>-&gt;</span>SetActorLocationAndRotation(AllFish[i].Position, NewRotation, <span style=color:#8be9fd;font-style:italic>false</span>, <span style=color:#ff79c6>nullptr</span>, ETeleportType<span style=color:#ff79c6>::</span>TeleportPhysics);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>             }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>}
</span></span></code></pre></div><p>The boids rules were adapted to use indices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>FVector UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Cohesion(<span style=color:#ff79c6>const</span> int32 InFishIndex, <span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;&amp;</span> InNeighborIndices) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    FVector CenterOfMass <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    int32 CohesionCount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>const</span> int32 CurrentGroupID <span style=color:#ff79c6>=</span> AllFish[InFishIndex].FlockGroupID;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> int32 <span style=color:#8be9fd;font-style:italic>NeighborIndex</span> : InNeighborIndices)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#ff79c6>if</span> (AllFish[NeighborIndex].FlockGroupID <span style=color:#ff79c6>!=</span> CurrentGroupID) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        CenterOfMass <span style=color:#ff79c6>+=</span> AllFish[NeighborIndex].Position;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        CohesionCount<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>if</span> (CohesionCount <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    CenterOfMass <span style=color:#ff79c6>/=</span> CohesionCount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    FVector Desired <span style=color:#ff79c6>=</span> CenterOfMass <span style=color:#ff79c6>-</span> AllFish[InFishIndex].Position;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>Steer</span>(AllFish[InFishIndex].Velocity, Desired, AllFish[InFishIndex].MaxForce);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><p>Similar adaptations for other rules.</p><p>Centralizing logic reduced per-actor overhead, as actors avoided flocking calculations unless targeted. AoS kept data contiguous for better cache access.</p><p>Profiling showed less time in actor ticking, with the simulation loop as the main focus.</p><p><figure><div class=img-container><img loading=lazy alt="Centralizing Logic & AoS Profile" src=/posts/1000_boids/step_2_profile.png></div></figure></p><p><strong>The Result:</strong> Improved architecture and reduced overhead, reaching around 22 FPS max.<figure><div class=img-container><img loading=lazy alt="Centralizing Logic & AoS Result" src=/posts/1000_boids/step_2.png></div></figure></p><h1 class=heading id=step-3-going-parallel-with-structure-of-arrays-soa>Step 3: Going Parallel with Structure of Arrays (SoA)
<a class=anchor href=#step-3-going-parallel-with-structure-of-arrays-soa>#</a></h1><p>For parallelism, data was restructured to Structure of Arrays (SoA) for cache efficiency.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// FROM: TArray&lt;FFishData&gt; AllFish;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4>// TO: Individual TArrays for each property
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>UPROPERTY(Transient) TArray<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*&gt;</span> FishActors;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>UPROPERTY(Transient) TMap<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>*</span>, int32<span style=color:#ff79c6>&gt;</span> FishActorToIndexMap;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>TMap<span style=color:#ff79c6>&lt;</span>FIntVector, TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;&gt;</span> SpatialGrid;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>int32 FishCount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> Positions;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> Velocities;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;</span> FlockGroupIDs;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> MaxSpeeds;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> MaxForces;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> NeighborRadii;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> SeparationDistances;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> CohesionWeights;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> SeparationWeights;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> AlignmentWeights;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> ContainmentWeights;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> ContainmentCheckDistances;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> SpawnAreaCenters;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> SpawnAreaBoxExtents;
</span></span></code></pre></div><p>SoA enhances locality, as accessing one property loads contiguous data.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=memory-race-viz-container class=html-diagram-container style=position:relative;min-height:450px></div></div><script type=module>
    if ('memory-layout' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('memory-race-viz-container'));
    } else if ('memory-layout' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('memory-race-viz-container'));
    } else if ('memory-layout' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('memory-race-viz-container'));
    } else if ('memory-layout' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('memory-race-viz-left');
        const right = document.getElementById('memory-race-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('memory-race-viz');
        const uiPanel = document.getElementById('memory-race-viz-ui');
        const controlsContainer = document.getElementById('memory-race-viz-controls');
        const helpText = document.getElementById('memory-race-viz-help-text');
        const overlay = document.getElementById('memory-race-viz-overlay');
        initScene(container, 'memory-layout', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><p>Registration maps actors to array indices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>RegisterFish(AActor_Fish<span style=color:#ff79c6>*</span> InFishActor)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>IsValid(InFishActor) <span style=color:#ff79c6>||</span> FishActorToIndexMap.Contains(InFishActor)) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>const</span> int32 NewIndex <span style=color:#ff79c6>=</span> FishCount<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    FishActors.Add(InFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    Positions.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetActorLocation());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    Velocities.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetActorForwardVector() <span style=color:#ff79c6>*</span> InFishActor<span style=color:#ff79c6>-&gt;</span>GetMaxSpeed() <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>0.5f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    FlockGroupIDs.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetFlockGroupID());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    MaxSpeeds.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetMaxSpeed());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    MaxForces.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetMaxForce());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    NeighborRadii.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetNeighborRadius());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    SeparationDistances.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetSeparationDistance());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    CohesionWeights.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetCohesionWeight());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    SeparationWeights.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetSeparationWeight());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    AlignmentWeights.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetAlignmentWeight());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ContainmentWeights.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetContainmentWeight());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    ContainmentCheckDistances.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetContainmentCheckDistance());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    SpawnAreaCenters.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetContainingSpawnAreaCenter());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    SpawnAreaBoxExtents.Add(InFishActor<span style=color:#ff79c6>-&gt;</span>GetContainingSpawnAreaBoxExtent());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    FishActorToIndexMap.Add(InFishActor, NewIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span></code></pre></div><h3 class=heading id=thread-safety-with-parallelfor>Thread Safety with <code>ParallelFor</code>
<a class=anchor href=#thread-safety-with-parallelfor>#</a></h3><p><code>ParallelFor</code> requires separating reads and writes to avoid races. The loop reads from current arrays and writes to separate next arrays. Updates are committed serially.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (FishCount <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    UpdateSpatialGrid();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> NextVelocities, NextPositions;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    NextVelocities.SetNumUninitialized(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    NextPositions.SetNumUninitialized(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#6272a4>// Phase 1: PARALLEL SIMULATION
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>    ParallelFor(FishCount, [<span style=color:#ff79c6>&amp;</span>](int32 i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>IsValid(FishActors[i]) <span style=color:#ff79c6>||</span> FishActors[i]<span style=color:#ff79c6>-&gt;</span>IsBeingTargeted())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            NextVelocities[i] <span style=color:#ff79c6>=</span> Velocities[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            NextPositions[i] <span style=color:#ff79c6>=</span> Positions[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;</span> NeighborIndices;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        FindNeighborsInRadius(i, NeighborRadii[i], NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>const</span> FVector FCohesion <span style=color:#ff79c6>=</span> Cohesion(i, NeighborIndices) <span style=color:#ff79c6>*</span> CohesionWeights[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#ff79c6>const</span> FVector FSeparation <span style=color:#ff79c6>=</span> Separation(i, NeighborIndices) <span style=color:#ff79c6>*</span> SeparationWeights[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#ff79c6>const</span> FVector FAlignment <span style=color:#ff79c6>=</span> Alignment(i, NeighborIndices) <span style=color:#ff79c6>*</span> AlignmentWeights[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>const</span> FVector FBoundary <span style=color:#ff79c6>=</span> BoundaryContainment(i) <span style=color:#ff79c6>*</span> ContainmentWeights[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#ff79c6>const</span> FVector TotalForce <span style=color:#ff79c6>=</span> FCohesion <span style=color:#ff79c6>+</span> FSeparation <span style=color:#ff79c6>+</span> FAlignment <span style=color:#ff79c6>+</span> FBoundary;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        FVector NewVelocity <span style=color:#ff79c6>=</span> Velocities[i] <span style=color:#ff79c6>+</span> TotalForce <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        NewVelocity <span style=color:#ff79c6>=</span> NewVelocity.GetClampedToMaxSize(MaxSpeeds[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        NextVelocities[i] <span style=color:#ff79c6>=</span> NewVelocity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        NextPositions[i] <span style=color:#ff79c6>=</span> Positions[i] <span style=color:#ff79c6>+</span> NewVelocity <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#6272a4>// Phase 2: SERIAL COMMIT (main thread only)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>    Positions <span style=color:#ff79c6>=</span> MoveTemp(NextPositions);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    Velocities <span style=color:#ff79c6>=</span> MoveTemp(NextVelocities);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#6272a4>// Phase 3: SERIAL ACTOR UPDATE (main thread only)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> FishCount; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        AActor_Fish<span style=color:#ff79c6>*</span> FishActor <span style=color:#ff79c6>=</span> FishActors[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        <span style=color:#ff79c6>if</span> (FishActor <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>!</span>FishActor<span style=color:#ff79c6>-&gt;</span>IsBeingTargeted())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>            <span style=color:#ff79c6>const</span> FRotator NewRotation <span style=color:#ff79c6>=</span> Velocities[i].ToOrientationRotator();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>            FishActor<span style=color:#ff79c6>-&gt;</span>SetActorLocationAndRotation(Positions[i], NewRotation, <span style=color:#8be9fd;font-style:italic>false</span>, <span style=color:#ff79c6>nullptr</span>, ETeleportType<span style=color:#ff79c6>::</span>TeleportPhysics);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>}
</span></span></code></pre></div><p>Rules access SoA directly for cache benefits.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=parallel-viz-container class=html-diagram-container style=position:relative></div></div><script type=module>
    if ('parallelization' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('parallel-viz-container'));
    } else if ('parallelization' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('parallel-viz-container'));
    } else if ('parallelization' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('parallel-viz-container'));
    } else if ('parallelization' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('parallel-viz-left');
        const right = document.getElementById('parallel-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('parallel-viz');
        const uiPanel = document.getElementById('parallel-viz-ui');
        const controlsContainer = document.getElementById('parallel-viz-controls');
        const helpText = document.getElementById('parallel-viz-help-text');
        const overlay = document.getElementById('parallel-viz-overlay');
        initScene(container, 'parallelization', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><p>Profiling confirmed better multi-core use, reducing frame time.<figure><div class=img-container><img loading=lazy alt="SoA & Parallelization Profile" src=/posts/1000_boids/step_3_profile_a.png></div></figure><figure><div class=img-container><img loading=lazy alt="SoA & Parallelization Profile" src=/posts/1000_boids/step_3_profile_b.png></div></figure></p><p><strong>The Result:</strong> Multi-core utilization improved performance to around 25 FPS max.<figure><div class=img-container><img loading=lazy alt="SoA & Parallelization Result" src=/posts/1000_boids/step_3.png></div></figure></p><p>A jump from 22 to 25 FPS might seem modest for a 16-core CPU. This is likely a sign of bottleneck shifting: the CPU work was now efficient enough to reveal that the true bottleneck lay elsewhere.</p><p>The overall frame rate was being limited by the GPU, which still had to process 1,000 individual draw calls. This confirmed that the next and most critical optimization had to be on the rendering side.</p><h1 class=heading id=step-4-ism-rendering>Step 4: ISM Rendering
<a class=anchor href=#step-4-ism-rendering>#</a></h1><p>The CPU was efficient, but GPU draw calls for 1000 actors were a bottleneck. <code>UInstancedStaticMeshComponent</code> (ISM) addressed this. By default, no <code>AActor_Fish</code> are spawned.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div class=threejs-double-container style=display:flex;flex-direction:row><div id=ism-rendering-viz-left style="width:50%;height:450px;position:relative;border-right:1px solid #ddd"></div><div id=ism-rendering-viz-right style=width:50%;height:450px;position:relative></div></div></div><script type=module>
    if ('ism-rendering' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('ism-rendering-viz-container'));
    } else if ('ism-rendering' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('ism-rendering-viz-container'));
    } else if ('ism-rendering' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('ism-rendering-viz-container'));
    } else if ('ism-rendering' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('ism-rendering-viz-left');
        const right = document.getElementById('ism-rendering-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('ism-rendering-viz');
        const uiPanel = document.getElementById('ism-rendering-viz-ui');
        const controlsContainer = document.getElementById('ism-rendering-viz-controls');
        const helpText = document.getElementById('ism-rendering-viz-help-text');
        const overlay = document.getElementById('ism-rendering-viz-overlay');
        initScene(container, 'ism-rendering', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><p><code>Actor_FishSpawnArea</code> provides assets and data to the <code>FishManager</code> without spawning actors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_FishSpawnArea<span style=color:#ff79c6>::</span>OnFishSpawnAssetLoaded()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    UObject<span style=color:#ff79c6>*</span> LoadedAsset <span style=color:#ff79c6>=</span> FishSpawnAssetHandle.Get()<span style=color:#ff79c6>-&gt;</span>GetLoadedAsset();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    UClass<span style=color:#ff79c6>*</span> LoadedAssetAsClass <span style=color:#ff79c6>=</span> Cast<span style=color:#ff79c6>&lt;</span>UClass<span style=color:#ff79c6>&gt;</span>(LoadedAsset);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>SpawnAreaBox)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        UE_LOG(LogFishingFeature, Error, TEXT(<span style=color:#f1fa8c>&#34;Spawn Area Box is not valid, this should not happen. Won&#39;t continue spawning fish...&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>FishSpawnAreaConfigData)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        UE_LOG(LogFishingFeature, Error, TEXT(<span style=color:#f1fa8c>&#34;Fish Spawn Area Config Data is not set, are you sure you have a valid data asset set? Won&#39;t continue spawning fish...&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>const</span> FFishSpawnAreaConfig FishSpawnAreaConfig <span style=color:#ff79c6>=</span> FishSpawnAreaConfigData<span style=color:#ff79c6>-&gt;</span>GetFishSpawnAreaConfig();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#6272a4>// We get the visual assets from the default object (CDO) of the Fish class
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4></span>    AActor_Fish<span style=color:#ff79c6>*</span> FishCDO <span style=color:#ff79c6>=</span> LoadedFishClass<span style=color:#ff79c6>-&gt;</span>GetDefaultObject<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    UStaticMeshComponent<span style=color:#ff79c6>*</span> MeshComponentCDO <span style=color:#ff79c6>=</span> FishCDO<span style=color:#ff79c6>-&gt;</span>FindComponentByClass<span style=color:#ff79c6>&lt;</span>UStaticMeshComponent<span style=color:#ff79c6>&gt;</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>MeshComponentCDO <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>MeshComponentCDO<span style=color:#ff79c6>-&gt;</span>GetStaticMesh()) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    UStaticMesh<span style=color:#ff79c6>*</span> FishMesh <span style=color:#ff79c6>=</span> MeshComponentCDO<span style=color:#ff79c6>-&gt;</span>GetStaticMesh();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    UMaterialInterface<span style=color:#ff79c6>*</span> FishMaterial <span style=color:#ff79c6>=</span> MeshComponentCDO<span style=color:#ff79c6>-&gt;</span>GetMaterial(<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#6272a4>// Give the manager the assets it needs to set up its ISM component
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span>    FishManager<span style=color:#ff79c6>-&gt;</span>SetFishAssets(LoadedFishClass, FishMesh, FishMaterial);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#6272a4>// Get spawn parameters from our config data asset
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> FFishSpawnAreaConfig FishSpawnAreaConfig <span style=color:#ff79c6>=</span> FishSpawnAreaConfigData<span style=color:#ff79c6>-&gt;</span>GetFishSpawnAreaConfig();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#ff79c6>const</span> int32 FishSpawnAmount <span style=color:#ff79c6>=</span> FishSpawnAreaConfig.FishSpawnAmount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#ff79c6>const</span> int32 NumFlockGroups <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Max(<span style=color:#bd93f9>1</span>, FishSpawnAreaConfig.NumberOfFlockGroups);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;</span> GroupIDsToAssign;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    GroupIDsToAssign.Reserve(FishSpawnAmount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#ff79c6>const</span> int32 BaseSize <span style=color:#ff79c6>=</span> FishSpawnAmount <span style=color:#ff79c6>/</span> NumFlockGroups;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    int32 Remainder <span style=color:#ff79c6>=</span> FishSpawnAmount <span style=color:#ff79c6>%</span> NumFlockGroups;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    <span style=color:#ff79c6>for</span> (int32 GroupIndex <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; GroupIndex <span style=color:#ff79c6>&lt;</span> NumFlockGroups; <span style=color:#ff79c6>++</span>GroupIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        int32 CurrentGroupSize <span style=color:#ff79c6>=</span> BaseSize <span style=color:#ff79c6>+</span> (Remainder <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>?</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> CurrentGroupSize; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>            GroupIDsToAssign.Add(GroupIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        <span style=color:#ff79c6>if</span> (Remainder <span style=color:#ff79c6>&lt;=</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        Remainder<span style=color:#ff79c6>--</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    <span style=color:#ff79c6>if</span> (GroupIDsToAssign.Num() <span style=color:#ff79c6>==</span> FishSpawnAmount)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#ff79c6>const</span> int32 LastIndex <span style=color:#ff79c6>=</span> GroupIDsToAssign.Num() <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>        <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;=</span> LastIndex; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>            <span style=color:#ff79c6>const</span> int32 RandIndex <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>RandRange(i, LastIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>            GroupIDsToAssign.Swap(i, RandIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>    <span style=color:#6272a4>// Now, instead of spawning actors, we just add pure data to the manager
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> UDataAsset_ActorFishConfig<span style=color:#ff79c6>*</span> ActorFishConfigData <span style=color:#ff79c6>=</span> FishCDO<span style=color:#ff79c6>-&gt;</span>GetActorFishConfigData();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    <span style=color:#ff79c6>if</span> (ActorFishConfigData)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>        <span style=color:#ff79c6>const</span> FActorFishConfig FishConfig <span style=color:#ff79c6>=</span> ActorFishConfigData<span style=color:#ff79c6>-&gt;</span>GetActorFishConfig();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>        FVector Min, Max;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>        MeshComponentCDO<span style=color:#ff79c6>-&gt;</span>GetLocalBounds(Min, Max);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>float</span> FishLength <span style=color:#ff79c6>=</span> (Max <span style=color:#ff79c6>-</span> Min).GetMax();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> FishSpawnAmount; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>            <span style=color:#ff79c6>const</span> FVector RandomLocation <span style=color:#ff79c6>=</span> UKismetMathLibrary<span style=color:#ff79c6>::</span>RandomPointInBoundingBox(CenterLocation, BoxExtent);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>            <span style=color:#ff79c6>const</span> int32 GroupID <span style=color:#ff79c6>=</span> (i <span style=color:#ff79c6>&lt;</span> GroupIDsToAssign.Num()) <span style=color:#ff79c6>?</span> GroupIDsToAssign[i] <span style=color:#ff79c6>:</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>            FishManager<span style=color:#ff79c6>-&gt;</span>AddFishData(RandomLocation, GroupID, FishConfig, CenterLocation, BoxExtent, FishSpawnAmount, FishLength);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>}
</span></span></code></pre></div><p>In <code>FishManager</code>, <code>SetFishAssets</code> sets up the component, and <code>AddFishData</code> populates arrays and instances.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>OnWorldBeginPlay(UWorld<span style=color:#ff79c6>&amp;</span> InWorld)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Super<span style=color:#ff79c6>::</span>OnWorldBeginPlay(InWorld);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#6272a4>// We need an actor in the world to own our component
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4></span>    ISMOwner <span style=color:#ff79c6>=</span> InWorld.SpawnActor<span style=color:#ff79c6>&lt;</span>AActor<span style=color:#ff79c6>&gt;</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    bIsInitialized <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>SetFishAssets(TSubclassOf<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span> InFishClass, UStaticMesh<span style=color:#ff79c6>*</span> InMesh, UMaterialInterface<span style=color:#ff79c6>*</span> InMaterial)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>bIsInitialized <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>ISMOwner <span style=color:#ff79c6>||</span> FishISMComponent) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    FishActorClass <span style=color:#ff79c6>=</span> InFishClass; <span style=color:#6272a4>// Store the class we&#39;ll need to spawn for promotion
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>    FishISMComponent <span style=color:#ff79c6>=</span> NewObject<span style=color:#ff79c6>&lt;</span>UInstancedStaticMeshComponent<span style=color:#ff79c6>&gt;</span>(ISMOwner);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>RegisterComponent();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>SetStaticMesh(InMesh);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#ff79c6>if</span> (InMaterial) FishISMComponent<span style=color:#ff79c6>-&gt;</span>SetMaterial(<span style=color:#bd93f9>0</span>, InMaterial);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>SetCollisionEnabled(ECollisionEnabled<span style=color:#ff79c6>::</span>NoCollision);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    ISMOwner<span style=color:#ff79c6>-&gt;</span>AddInstanceComponent(FishISMComponent);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>AddFishData(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> InPosition, int32 InFlockGroupID, <span style=color:#ff79c6>const</span> FActorFishConfig<span style=color:#ff79c6>&amp;</span> FishConfig, <span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> InSpawnCenter, <span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> InSpawnExtent, int32 TotalFishInSim, <span style=color:#8be9fd>float</span> FishLength)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>FishISMComponent) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#6272a4>// OPTIMIZATION: Add to the initial buffer [0] for our double-buffered arrays
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span>    Positions[<span style=color:#bd93f9>0</span>].Add(InPosition);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    Velocities[<span style=color:#bd93f9>0</span>].Add(FMath<span style=color:#ff79c6>::</span>VRand().GetSafeNormal() <span style=color:#ff79c6>*</span> FishConfig.MaxSpeed <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>0.5f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    FlockGroupIDs.Add(InFlockGroupID);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    MaxSpeeds.Add(FishConfig.MaxSpeed);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    MaxForces.Add(FishConfig.MaxForce);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    NeighborRadii.Add(FishConfig.NeighborRadius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    SeparationDistances.Add(FishConfig.SeparationDistance);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    CohesionWeights.Add(FishConfig.CohesionWeight);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    SeparationWeights.Add(FishConfig.SeparationWeight);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    AlignmentWeights.Add(FishConfig.AlignmentWeight);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    ContainmentWeights.Add(FishConfig.ContainmentWeight);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    ContainmentCheckDistances.Add(FishConfig.ContainmentCheckDistance);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    SpawnAreaCenters.Add(InSpawnCenter);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    SpawnAreaBoxExtents.Add(InSpawnExtent);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    <span style=color:#6272a4>// BEHAVIOR: Add data for wandering
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#6272a4></span>    WanderVectors.Add(FMath<span style=color:#ff79c6>::</span>VRand());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    WanderStrengths.Add(<span style=color:#bd93f9>1.5f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    WanderJitters.Add(<span style=color:#bd93f9>10.0f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    <span style=color:#6272a4>// OPTIMIZATION: Keep track of the largest neighbor radius to set an optimal grid cell size
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4></span>    MaxNeighborRadius <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Max(MaxNeighborRadius, FishConfig.NeighborRadius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    SpatialGridCellSize <span style=color:#ff79c6>=</span> MaxNeighborRadius <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0.f</span> <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>MaxNeighborRadius</span> : <span style=color:#bd93f9>1000.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    IsBoidPromoted.Add(<span style=color:#8be9fd;font-style:italic>false</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#6272a4>// Add a visual instance for this new fish at its starting location
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>const</span> FTransform <span style=color:#50fa7b>InitialTransform</span>(InPosition);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>AddInstance(InitialTransform);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    FishCount<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>}
</span></span></code></pre></div><p>The <code>Tick</code> updates ISM transforms in batch:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#6272a4>// ... simulation code ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#6272a4></span>    TArray<span style=color:#ff79c6>&lt;</span>FTransform<span style=color:#ff79c6>&gt;</span> CurrentTransforms;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    CurrentTransforms.Reserve(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> FishCount; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#ff79c6>if</span> (IsBoidPromoted[i]) <span style=color:#ff79c6>continue</span>; <span style=color:#6272a4>// Skip promoted ones, as they are actors
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>        CurrentTransforms.Add(FTransform(Velocities[i].ToOrientationRotator(), Positions[i]));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#ff79c6>if</span> (CurrentTransforms.Num() <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        FishISMComponent<span style=color:#ff79c6>-&gt;</span>BatchUpdateInstancesTransforms(<span style=color:#bd93f9>0</span>, CurrentTransforms, <span style=color:#8be9fd;font-style:italic>true</span>, <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>The promote/demote pattern handles interactions by swapping instances for actors.</p><p>When finding nearest, query index and promote:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>bool</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>FindNearestBoid(<span style=color:#ff79c6>const</span> FVector<span style=color:#ff79c6>&amp;</span> Location, <span style=color:#8be9fd>float</span> Radius, int32<span style=color:#ff79c6>&amp;</span> OutBoidIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    OutBoidIndex <span style=color:#ff79c6>=</span> INDEX_NONE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#8be9fd>float</span> MinDistSquared <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Square(Radius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> FishCount; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#ff79c6>if</span> (IsBoidPromoted[i]) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#8be9fd>float</span> DistSquared <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>DistSquared(Location, Positions[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#ff79c6>if</span> (DistSquared <span style=color:#ff79c6>&lt;</span> MinDistSquared)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            MinDistSquared <span style=color:#ff79c6>=</span> DistSquared;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            OutBoidIndex <span style=color:#ff79c6>=</span> i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#ff79c6>return</span> OutBoidIndex <span style=color:#ff79c6>!=</span> INDEX_NONE;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>AActor_Fish<span style=color:#ff79c6>*</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>PromoteBoidToActor(int32 BoidIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#ff79c6>if</span> (BoidIndex <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> BoidIndex <span style=color:#ff79c6>&gt;=</span> FishCount <span style=color:#ff79c6>||</span> IsBoidPromoted[BoidIndex] <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>FishActorClass) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    UWorld<span style=color:#ff79c6>*</span> World <span style=color:#ff79c6>=</span> GetWorld();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>World) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    FActorSpawnParameters SpawnParams;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    SpawnParams.SpawnCollisionHandlingOverride <span style=color:#ff79c6>=</span> ESpawnActorCollisionHandlingMethod<span style=color:#ff79c6>::</span>AlwaysSpawn;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    AActor_Fish<span style=color:#ff79c6>*</span> NewFishActor <span style=color:#ff79c6>=</span> World<span style=color:#ff79c6>-&gt;</span>SpawnActor<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span>(FishActorClass, Positions[BoidIndex], Velocities[BoidIndex].ToOrientationRotator(), SpawnParams);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>NewFishActor) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#6272a4>// Sync state from boid to actor
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span>    NewFishActor<span style=color:#ff79c6>-&gt;</span>SetSpawnAreaCenterAndExtent(SpawnAreaCenters[BoidIndex], SpawnAreaBoxExtents[BoidIndex]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    NewFishActor<span style=color:#ff79c6>-&gt;</span>SetFlockGroupID(FlockGroupIDs[BoidIndex]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    NewFishActor<span style=color:#ff79c6>-&gt;</span>SetTotalFishInSimulation(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    NewFishActor<span style=color:#ff79c6>-&gt;</span>SetBoidIndex(BoidIndex, <span style=color:#ff79c6>this</span>); <span style=color:#6272a4>// So actor knows its origin
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#6272a4>// Hide the instance
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4></span>    FTransform HiddenTransform <span style=color:#ff79c6>=</span> FTransform<span style=color:#ff79c6>::</span>Identity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    HiddenTransform.SetScale3D(FVector<span style=color:#ff79c6>::</span>ZeroVector);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>UpdateInstanceTransform(BoidIndex, HiddenTransform, <span style=color:#8be9fd;font-style:italic>false</span>, <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    IsBoidPromoted[BoidIndex] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    PromotedFishActors.Add(BoidIndex, NewFishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    ActorToBoidIndexMap.Add(NewFishActor, BoidIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    <span style=color:#ff79c6>return</span> NewFishActor;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>}
</span></span></code></pre></div><p>Demotion hides the actor and restores the instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>DemoteActorToBoid(int32 BoidIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    TObjectPtr<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;*</span> ActorPtr <span style=color:#ff79c6>=</span> PromotedFishActors.Find(BoidIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>ActorPtr <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!*</span>ActorPtr) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    AActor_Fish<span style=color:#ff79c6>*</span> FishActor <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>*</span>ActorPtr;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#6272a4>// Sync state back if needed
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>    Positions[BoidIndex] <span style=color:#ff79c6>=</span> FishActor<span style=color:#ff79c6>-&gt;</span>GetActorLocation();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    Velocities[BoidIndex] <span style=color:#ff79c6>=</span> FishActor<span style=color:#ff79c6>-&gt;</span>GetVelocity();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#6272a4>// Restore the instance
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>    FTransform <span style=color:#50fa7b>RestoreTransform</span>(Velocities[BoidIndex].ToOrientationRotator(), Positions[BoidIndex]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    FishISMComponent<span style=color:#ff79c6>-&gt;</span>UpdateInstanceTransform(BoidIndex, RestoreTransform, <span style=color:#8be9fd;font-style:italic>false</span>, <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#6272a4>// Destroy the actor
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>    FishActor<span style=color:#ff79c6>-&gt;</span>Destroy();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    IsBoidPromoted[BoidIndex] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    PromotedFishActors.Remove(BoidIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ActorToBoidIndexMap.Remove(FishActor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><p>In <code>AActor_Fish</code>, track for demotion:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>SetBoidIndex(int32 InBoidIndex, UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>*</span> InManager)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    BoidIndex <span style=color:#ff79c6>=</span> InBoidIndex;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ManagerPtr <span style=color:#ff79c6>=</span> InManager;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd>void</span> AActor_Fish<span style=color:#ff79c6>::</span>EndPlay(<span style=color:#ff79c6>const</span> EEndPlayReason<span style=color:#ff79c6>::</span>Type EndPlayReason)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#ff79c6>if</span> (ManagerPtr.IsValid() <span style=color:#ff79c6>&amp;&amp;</span> BoidIndex <span style=color:#ff79c6>!=</span> INDEX_NONE)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        ManagerPtr<span style=color:#ff79c6>-&gt;</span>DemoteActorToBoid(BoidIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    Super<span style=color:#ff79c6>::</span>EndPlay(EndPlayReason);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span></code></pre></div><p>ISM batches draws, reducing GPU load from 1000 meshes to one. Only promoted fish are actors.</p><p>Profiling showed significant GPU time reduction via instancing.<figure><div class=img-container><img loading=lazy alt="ISM Rendering Profile" src=/posts/1000_boids/step_4_profile.png></div></figure></p><p><strong>The Result:</strong> Resolved GPU issues. Around 71 FPS max.<figure><div class=img-container><img loading=lazy alt="ISM Rendering Result" src=/posts/1000_boids/step_4.png></div></figure></p><h1 class=heading id=step-5-buffering-and-tweaks-for-efficiency>Step 5: Buffering and Tweaks for Efficiency
<a class=anchor href=#step-5-buffering-and-tweaks-for-efficiency>#</a></h1><p>The final refinements focused on making the parallel simulation loop more optimized.</p><ol><li><strong>Implementing Double Buffering for Parallel Safety</strong>
The previous step used temporary arrays for the next frame&rsquo;s data, which were then moved back into the main arrays using <code>MoveTemp</code>. While <code>MoveTemp</code> is extremely efficient, a more robust pattern for parallel processing is double buffering.</li></ol><p>Instead of creating temporary arrays each frame, two persistent sets of arrays are maintained for positions and velocities. In any given frame, one set acts as the immutable read buffer, while the other serves as the write buffer.</p><div class=diagram-wrapper style="margin-bottom:1.5rem;border:1px solid #ddd;border-radius:4px;overflow:hidden;background-color:#f0f0f0"><div id=double-buffer-viz-container class=html-diagram-container style=position:relative;min-height:450px></div></div><script type=module>
    if ('double-buffer' === 'memory-layout') {
        const { initMemoryLayoutScene2D } = await import('\/js\/boids-visualizer.js');
        initMemoryLayoutScene2D(document.getElementById('double-buffer-viz-container'));
    } else if ('double-buffer' === 'parallelization') {
        const { initParallelismScene } = await import('\/js\/boids-visualizer.js');
        initParallelismScene(document.getElementById('double-buffer-viz-container'));
    } else if ('double-buffer' === 'double-buffer') {
        const { initDoubleBufferScene } = await import('\/js\/boids-visualizer.js');
        initDoubleBufferScene(document.getElementById('double-buffer-viz-container'));
    } else if ('double-buffer' === 'ism-rendering') {
        const { initIsmScene } = await import('\/js\/boids-visualizer.js');
        const left = document.getElementById('double-buffer-viz-left');
        const right = document.getElementById('double-buffer-viz-right');
        initIsmScene(left, right);
    } else {
        const { initScene } = await import('\/js\/boids-visualizer.js');
        const container = document.getElementById('double-buffer-viz');
        const uiPanel = document.getElementById('double-buffer-viz-ui');
        const controlsContainer = document.getElementById('double-buffer-viz-controls');
        const helpText = document.getElementById('double-buffer-viz-help-text');
        const overlay = document.getElementById('double-buffer-viz-overlay');
        initScene(container, 'double-buffer', { uiPanel, controlsContainer, helpText, overlay });
    }
</script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>// Double-buffering for data that changes each frame.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4></span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> Positions[<span style=color:#bd93f9>2</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> Velocities[<span style=color:#bd93f9>2</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>int32 CurrentBufferIndex <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; <span style=color:#6272a4>// 0 is read, 1 is write (or vice-versa)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>// Data for wandering behavior
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>TArray<span style=color:#ff79c6>&lt;</span>FVector<span style=color:#ff79c6>&gt;</span> WanderVectors;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> WanderStrengths;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>float</span><span style=color:#ff79c6>&gt;</span> WanderJitters;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4>// Dynamically sized spatial grid
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span><span style=color:#8be9fd>float</span> SpatialGridCellSize <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1000.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#8be9fd>float</span> MaxNeighborRadius <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0.f</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#6272a4>// State tracking for Promote/Demote
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#6272a4></span>TArray<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>bool</span><span style=color:#ff79c6>&gt;</span> IsBoidPromoted;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>UPROPERTY() TMap<span style=color:#ff79c6>&lt;</span>int32, TObjectPtr<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;&gt;</span> PromotedFishActors;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>UPROPERTY() TMap<span style=color:#ff79c6>&lt;</span>TObjectPtr<span style=color:#ff79c6>&lt;</span>AActor_Fish<span style=color:#ff79c6>&gt;</span>, int32<span style=color:#ff79c6>&gt;</span> ActorToBoidIndexMap;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#6272a4>// ... other SoA data remains the same ...
</span></span></span></code></pre></div><p>This approach has two key advantages:</p><ul><li>Guaranteed Thread Safety: It provides a clean, formal separation of read and write data. The <code>ParallelFor</code> loop can safely read from the <code>ReadIndex</code> buffer knowing it will not be modified, while concurrently writing results to the <code>WriteIndex</code> buffer. This is a safe way to prevent data race when doing parallelism.</li><li>Eliminates Mid-Frame Allocations: Since both buffers are pre-allocated and persist, it guarantees zero memory reallocations during the <code>Tick</code> function. This eliminates a potential source of performance hitches, making frame times more stable and predictable.</li></ul><p>At the end of the tick, &ldquo;flipping&rdquo; the buffers is a virtually zero-cost operation. It&rsquo;s just a single integer assignment.</p><p>In <code>AddFishData</code>, set cell size dynamically:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>MaxNeighborRadius <span style=color:#ff79c6>=</span> FMath<span style=color:#ff79c6>::</span>Max(MaxNeighborRadius, FishConfig.NeighborRadius);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>SpatialGridCellSize <span style=color:#ff79c6>=</span> MaxNeighborRadius <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0.f</span> <span style=color:#ff79c6>?</span> <span style=color:#8be9fd;font-style:italic>MaxNeighborRadius</span> : <span style=color:#bd93f9>1000.f</span>;
</span></span></code></pre></div><p>This optimizes grid for different radii.</p><ol start=2><li><strong>Accumulating Desired Velocities:</strong> Rules return desired velocity, steered once.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>FVector UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Cohesion(int32 FishIndex, <span style=color:#ff79c6>const</span> TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;&amp;</span> NeighborIndices) <span style=color:#ff79c6>const</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#6272a4>// ... calculate CenterOfMass ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> (CohesionCount <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>return</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    CenterOfMass <span style=color:#ff79c6>/=</span> CohesionCount;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#ff79c6>return</span> (CenterOfMass <span style=color:#ff79c6>-</span> Positions[CurrentBufferIndex][FishIndex]).GetSafeNormal() <span style=color:#ff79c6>*</span> MaxSpeeds[FishIndex];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>Accumulate and steer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>const</span> FVector WeightedTotal <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    (DesiredCohesion <span style=color:#ff79c6>*</span> CohesionWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    (DesiredSeparation <span style=color:#ff79c6>*</span> SeparationWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    (DesiredAlignment <span style=color:#ff79c6>*</span> AlignmentWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    (DesiredBoundary <span style=color:#ff79c6>*</span> ContainmentWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    (DesiredWander <span style=color:#ff79c6>*</span> WanderStrengths[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>FVector TotalForce <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>WeightedTotal.IsNearlyZero())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    FVector DesiredVelocity <span style=color:#ff79c6>=</span> WeightedTotal.GetSafeNormal() <span style=color:#ff79c6>*</span> MaxSpeeds[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    TotalForce <span style=color:#ff79c6>=</span> Steer(CurrentVelocity, DesiredVelocity, MaxForces[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>This minimizes operations.</p><p>Added wandering for natural movement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>WanderVectors[i] <span style=color:#ff79c6>+=</span> FMath<span style=color:#ff79c6>::</span>VRand() <span style=color:#ff79c6>*</span> WanderJitters[i] <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>WanderVectors[i].Normalize();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>const</span> FVector DesiredWander <span style=color:#ff79c6>=</span> WanderVectors[i] <span style=color:#ff79c6>*</span> MaxSpeeds[i];
</span></span></code></pre></div><p>Final <code>Tick</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8be9fd>void</span> UTickableWorldSubsystem_FishManager<span style=color:#ff79c6>::</span>Tick(<span style=color:#8be9fd>float</span> DeltaTime)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#ff79c6>if</span> (FishCount <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>FishISMComponent) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>const</span> int32 ReadIndex <span style=color:#ff79c6>=</span> CurrentBufferIndex;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#ff79c6>const</span> int32 WriteIndex <span style=color:#ff79c6>=</span> (CurrentBufferIndex <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    UpdateSpatialGrid(); <span style=color:#6272a4>// Reads from [ReadIndex]
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    Positions[WriteIndex].SetNumUninitialized(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Velocities[WriteIndex].SetNumUninitialized(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ParallelFor(FishCount, [<span style=color:#ff79c6>&amp;</span>](int32 i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#ff79c6>if</span> (IsBoidPromoted[i])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            Velocities[WriteIndex][i] <span style=color:#ff79c6>=</span> Velocities[ReadIndex][i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            Positions[WriteIndex][i] <span style=color:#ff79c6>=</span> Positions[ReadIndex][i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>const</span> FVector CurrentPosition <span style=color:#ff79c6>=</span> Positions[ReadIndex][i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#ff79c6>const</span> FVector CurrentVelocity <span style=color:#ff79c6>=</span> Velocities[ReadIndex][i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        TArray<span style=color:#ff79c6>&lt;</span>int32<span style=color:#ff79c6>&gt;</span> NeighborIndices;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        FindNeighborsInRadius(i, NeighborRadii[i], NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#ff79c6>const</span> FVector DesiredCohesion <span style=color:#ff79c6>=</span> Cohesion(i, NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#ff79c6>const</span> FVector DesiredSeparation <span style=color:#ff79c6>=</span> Separation(i, NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#ff79c6>const</span> FVector DesiredAlignment <span style=color:#ff79c6>=</span> Alignment(i, NeighborIndices);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#ff79c6>const</span> FVector DesiredBoundary <span style=color:#ff79c6>=</span> BoundaryContainment(i);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        WanderVectors[i] <span style=color:#ff79c6>+=</span> FMath<span style=color:#ff79c6>::</span>VRand() <span style=color:#ff79c6>*</span> WanderJitters[i] <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        WanderVectors[i].Normalize();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#ff79c6>const</span> FVector DesiredWander <span style=color:#ff79c6>=</span> WanderVectors[i] <span style=color:#ff79c6>*</span> MaxSpeeds[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#ff79c6>const</span> FVector WeightedTotal <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>            (DesiredCohesion <span style=color:#ff79c6>*</span> CohesionWeights[i]) <span style=color:#ff79c6>+</span> (DesiredSeparation <span style=color:#ff79c6>*</span> SeparationWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>            (DesiredAlignment <span style=color:#ff79c6>*</span> AlignmentWeights[i]) <span style=color:#ff79c6>+</span> (DesiredBoundary <span style=color:#ff79c6>*</span> ContainmentWeights[i]) <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>            (DesiredWander <span style=color:#ff79c6>*</span> WanderStrengths[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>        FVector TotalForce <span style=color:#ff79c6>=</span> FVector<span style=color:#ff79c6>::</span>ZeroVector;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        <span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>WeightedTotal.IsNearlyZero())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>            FVector DesiredVelocity <span style=color:#ff79c6>=</span> WeightedTotal.GetSafeNormal() <span style=color:#ff79c6>*</span> MaxSpeeds[i];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>            TotalForce <span style=color:#ff79c6>=</span> Steer(CurrentVelocity, DesiredVelocity, MaxForces[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>       
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>        FVector NewVelocity <span style=color:#ff79c6>=</span> CurrentVelocity <span style=color:#ff79c6>+</span> TotalForce <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        Velocities[WriteIndex][i] <span style=color:#ff79c6>=</span> NewVelocity.GetClampedToMaxSize(MaxSpeeds[i]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        Positions[WriteIndex][i] <span style=color:#ff79c6>=</span> CurrentPosition <span style=color:#ff79c6>+</span> Velocities[WriteIndex][i] <span style=color:#ff79c6>*</span> DeltaTime;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>    CurrentBufferIndex <span style=color:#ff79c6>=</span> WriteIndex; <span style=color:#6272a4>// Flip buffers - zero cost!
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#6272a4></span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    TArray<span style=color:#ff79c6>&lt;</span>FTransform<span style=color:#ff79c6>&gt;</span> CurrentTransforms;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    CurrentTransforms.Reserve(FishCount);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#ff79c6>for</span> (int32 i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> FishCount; <span style=color:#ff79c6>++</span>i)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        <span style=color:#ff79c6>if</span> (IsBoidPromoted[i])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>            CurrentTransforms.Add(FTransform(FQuat<span style=color:#ff79c6>::</span>Identity, Positions[CurrentBufferIndex][i], FVector<span style=color:#ff79c6>::</span>ZeroVector));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>        <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>            CurrentTransforms.Add(FTransform(Velocities[CurrentBufferIndex][i].ToOrientationRotator(), Positions[CurrentBufferIndex][i]));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>   
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    <span style=color:#ff79c6>if</span> (CurrentTransforms.Num() <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>        FishISMComponent<span style=color:#ff79c6>-&gt;</span>BatchUpdateInstancesTransforms(<span style=color:#bd93f9>0</span>, CurrentTransforms, <span style=color:#8be9fd;font-style:italic>true</span>, <span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>}
</span></span></code></pre></div><p>Profiling showed low overhead and stable performance.<figure><div class=img-container><img loading=lazy alt="Double-buffer & accumulating desired movement profile" src=/posts/1000_boids/step_5_profile.png></div></figure></p><p><strong>The Result</strong>: Further refinements brought performance to around 74 FPS max.<figure><div class=img-container><img loading=lazy alt="Double-buffer & accumulating desired movement result" src=/posts/1000_boids/step_5.png></div></figure></p><h1 class=heading id=whats-next-part-2-graduating-to-mass>What&rsquo;s Next? Part 2: Graduating to Mass?
<a class=anchor href=#whats-next-part-2-graduating-to-mass>#</a></h1><p>This system aligns with Unreal Engine&rsquo;s Mass Entity Component System. Refactoring to Mass could provide further gains and integration. More on that in a future update, coming soonâ¢</p><h1 class=heading id=conclusion>Conclusion
<a class=anchor href=#conclusion>#</a></h1><p>Improving from 6 FPS to over 70 FPS demonstrates an optimization approach: start basic, profile, and address bottlenecks systematically, shifting from object-oriented to adhere more to data-oriented design principles.</p><div class=table-outer><table><thead><tr><th style=text-align:left>Step</th><th style=text-align:left>Technique</th><th style=text-align:left>Key Idea</th></tr></thead><tbody><tr><td style=text-align:left><strong>Start</strong></td><td style=text-align:left>Naive Actors</td><td style=text-align:left>Simple, but O(NÂ²) neighbor search impacted performance.</td></tr><tr><td style=text-align:left><strong>1</strong></td><td style=text-align:left>Spatial Grid</td><td style=text-align:left>Replaced full searches with localized lookups.</td></tr><tr><td style=text-align:left><strong>2</strong></td><td style=text-align:left>AoS & Centralization</td><td style=text-align:left>Moved logic to manager, reduced actor ticking.</td></tr><tr><td style=text-align:left><strong>3</strong></td><td style=text-align:left>SoA & Parallelization</td><td style=text-align:left>Restructured data for multi-core use.</td></tr><tr><td style=text-align:left><strong>4</strong></td><td style=text-align:left><strong>ISM Rendering</strong></td><td style=text-align:left><strong>Major gain.</strong> Used instances for GPU efficiency.</td></tr><tr><td style=text-align:left><strong>5</strong></td><td style=text-align:left>Final Polish</td><td style=text-align:left>Buffering and tweaks for efficiency.</td></tr></tbody></table></div><p>For large-scale simulations, this journey from 6 to over 70 FPS demonstrates that data-oriented approaches leveraging engine capabilities are a highly effective strategy.</p><p>This has been a deep dive into a complex optimization process. Feedback is always welcome if this kind of detailed, code-heavy breakdown is valuable.</p><p>Thank you for reading. Hopefully, this detailed writeup proves useful in your own projects. See you next time!</p></div></article><div class=single-comments><script src=https://giscus.app/client.js data-repo=rezonated/portfolio-workspace data-repo-id=R_kgDOO7BdjA data-category data-category-id=DIC_kwDOO7BdjM4Crcmc data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=dark data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></main></div><footer></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body><script src=/js/theme-switch.js></script><script defer src=/js/copy-code.js></script><script src=https://code.jquery.com/jquery-3.6.0.min.js></script><script src=/js/lastfm.js></script></html>